# 数位难度配置文件说明文档

## 📋 概述

`digit-difficulty.json` 是数位难度系统的核心配置文件，用于控制游戏中题目的难度递增、技能权重分布、表达式类型选择等关键参数。

## 🔧 配置文件结构

```json
{
  "version": "2.0",
  "digitDifficultyLevels": [
    {
      "level": 1,                    // 难度等级
      "digitRange": { "min": 2, "max": 3 },  // 数字位数范围
      "skills": { ... },             // 技能权重分布
      "expressions": { ... },         // 表达式类型配置
      "allowNegative": false,        // 是否允许负数
      "allowFractions": false,        // 是否允许分数
      "allowDecimals": false,         // 是否允许小数
      "timePerQuestionMs": 15000,   // 每题时间（毫秒）
      "minTimeMs": 8000,             // 倒计时最小时间（毫秒）
      "questionCount": 10            // 每关题目数量
    }
  ]
}
```

## 📊 详细字段说明

### 基础配置

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| `level` | number | 难度等级，必须唯一且递增 | 1, 5, 10, 30, 50, 70, 85, 100 |
| `digitRange` | object | 目标数字的位数范围 | `{ "min": 2, "max": 3 }` |
| `questionCount` | number | 每关的题目数量 | 10 |

### 技能权重配置 (skills)

控制各种验算技巧的出现概率，权重总和不需要为1，系统会自动按比例选择：

```json
"skills": {
  "lastDigit": 0.4,        // 尾数法
  "estimate": 0.3,           // 估算法
  "parity": 0.05,            // 奇偶性法
  "castingOutNines": 0.1,    // 弃九法
  "carryBorrow": 0.15,        // 进位借位法
  "specialDigits": 0.1        // 特殊整除性
}
```

**权重计算逻辑：**
- 系统将所有权重求和：`total = 0.4 + 0.3 + 0.05 + 0.1 + 0.15 + 0.1 = 1.1`
- 按权重比例随机选择技能：尾数法有 36.4% 概率被选中
- 插值算法会平滑调整相邻等级间的权重

### 表达式配置 (expressions)

控制题目中数学表达式的复杂程度和类型：

```json
"expressions": {
  "twoTerms": {
    "simple": { "plus": 0.4, "minus": 0.4, "mul": 0.2, "div": 0.1 },
    "withParentheses": { "plus": 0.05, "minus": 0.05, "mul": 0.05, "div": 0.05 }
  },
  "threeTerms": {
    "noParentheses": { "plusMinus": 0.2, "withMul": 0.15, "withDiv": 0.05 },
    "withParentheses": { "plusMinus": 0.1, "mul": 0.05, "div": 0.05 }
  }
}
```

#### 表达式类型说明

**两数字表达式 (twoTerms):**
- `simple`: 基础表达式，如 `5 + 3`
- `withParentheses`: 带括号表达式，如 `(5 + 3)`

**三数字表达式 (threeTerms):**
- `noParentheses`: 无括号表达式，如 `2 + 3 + 4`
- `withParentheses`: 带括号表达式，如 `(2 + 3) + 4`

**运算符权重：**
- `twoTerms.simple`: 控制基础运算符的分布
- `twoTerms.withParentheses`: 控制带括号运算符的分布
- `threeTerms.*`: 控制三数字运算的复杂度

### 时间配置

| 字段 | 类型 | 说明 | 使用场景 | 示例 |
|------|------|------|----------|--------|
| `timePerQuestionMs` | number | 每题的基础时间（毫秒） | 计时器总时长 | 15000ms |
| `minTimeMs` | number | 倒计时的最小时间（毫秒） | **⚠️ 注意：当前版本未使用** | 8000ms |

**⚠️ minTimeMs 说明：**
- **设计初衷**：用于限制最短答题时间，防止玩家过快答题
- **当前实现**：在 `GameScene.ts` 中仅使用 `timePerQuestionMs`，`minTimeMs` 暂时未被使用
- **未来计划**：可能用于实现答题速度限制或最短等待时间

### 其他配置

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|--------|
| `allowNegative` | boolean | 是否允许题目中出现负数 | `false` (低难度) → `true` (高难度) |
| `allowFractions` | boolean | 是否允许分数运算 | `false` → `true` |
| `allowDecimals` | boolean | 是否允许小数运算 | `false` → `true` |

## 🎯 配置设计原则

### 1. 权重不需要总和为1
权重是**相对值**，系统会自动计算总和并按比例选择。这提供了更大的灵活性：

```json
// ✅ 正确 - 权重是相对比例
"simple": { "plus": 60, "minus": 40, "mul": 10, "div": 0 }

// ❌ 不需要强制总和为1
"simple": { "plus": 0.6, "minus": 0.4, "mul": 0.1, "div": 0.25 }  // 总和1.35也正常工作
```

### 2. 括号配置不是多余的

`withParentheses` 用于控制**运算优先级**的表达式：
- 普通表达式：`5 + 3 × 2` = 11
- 带括号表达式：`(5 + 3) × 2` = 16

这在数学教育中很重要，帮助学生理解运算顺序。

### 3. 难度递增策略

配置遵循以下递增原则：

1. **数字位数**：从2位数逐步增加到10位数
2. **技能复杂度**：从基础技能（尾数法）到高级技能（弃九法）
3. **表达式复杂度**：从两数字简单表达式到三数字带括号表达式
4. **运算符种类**：从加减法逐步引入乘除法

## 🔄 插值算法说明

系统使用线性插值在相邻等级之间平滑过渡：

```javascript
// 示例：level 5 在 level 1 和 level 10 之间
t = (5 - 1) / (10 - 1) = 0.444...

// 技能权重插值
lastDigit = 0.7 + (0.4 - 0.7) * t ≈ 0.567
```

## 📝 配置修改指南

### 修改技能权重
```json
// 增加尾数法的出现概率
"skills": {
  "lastDigit": 0.8,  // 从 0.4 增加到 0.8
  "estimate": 0.2   // 相应减少其他技能权重
}
```

### 调整表达式类型分布
```json
// 增加乘法题目的比例
"twoTerms": {
  "simple": { "plus": 0.3, "minus": 0.3, "mul": 0.4, "div": 0 }
}
```

### 添加新的难度等级
```json
{
  "level": 110,
  "digitRange": { "min": 10, "max": 12 },
  "skills": { ... },
  "expressions": { ... }
}
```

## ⚠️ 注意事项

1. **版本控制**：必须保持 `version: "2.0"`
2. **唯一等级**：每个 `level` 值必须唯一
3. **递增顺序**：`digitDifficultyLevels` 数组中的等级必须按升序排列
4. **权重验证**：权重应该为非负数，负权重会被忽略

## 🧪 测试验证

配置修改后，运行以下测试验证效果：

```bash
npm test -- --testPathPattern=".*Difficulty.*\.test\.ts"
```

- ✅ `InterpolationLogic.test.ts` - 验证插值算法的数学正确性
- ✅ `DigitDifficultySystem.test.ts` - 验证配置系统的完整功能
- ✅ `SkillValidation.test.ts` - 验证技能在游戏中的实际表现

---

**文档版本**: 1.0
**最后更新**: 2025年10月2日
**维护者**: Tica Detective Team